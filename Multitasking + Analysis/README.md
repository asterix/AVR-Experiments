# Multitasking and Analysis

## Introduction

So, this whole implementation was for a course work. But since I implemented this in a very generic, modifiable way, I thought I'll just put this one along with my AVR projects.

The core of this is to execute multiple tasks with some pseudo-scheduling mechanism to run each task. You'll then be able to configure experiments based on some defined objectives. You can then dynamically run these experiments and get a report of how your system performed.

So step-wise:
```
Step 1: Decide on your tasks, code, modify existing etc. Modify main.c to accomplish this.
Step 2: Decide on your multitasking experiments. Configure them in uart_menu.c.
Step 3: Boot up the system, you'll see a menu on UART to run your experiments. Run the experiment that you want.
Step 4: Stop/Pause the system and get a report of your experiments
Step 5: Repeat/Reset
```

Overall, this is a great way to try out a task set for your embedded project. You can easily test/modify task set behavior and interoperability.

## Default tasks

* Time Keeper Task: Keeps track of number of milliseconds elapsed.
* Communication Task: Throws a menu prompt using UART to run/stop/get a report of experiments.
* RED LED Task: Toggle an LED every 100ms in ```main()```.
* YELLOW LED Task: Toggle an LED every 100ms inside an ```ISR```.
* JITTER LED Task: Random toggling of an LED for 5ms. Can't be interrupted during those 5ms.
* GREEN LED Task: Hardware driven, PWM based LED toggling every 100ms.
* GREEN LED Counting Task: Interrupt on the above toggle. Count up for every toggle.
* Hough Transform Task: Runs Hough transform on a small image segment. Takes ```< 50ms``` of time.


## Wiring instructions
My system works on hard timing reference generated by cascaded timers, so an external connection needs to be made before powering the system ON. The logic used is to tick and internal timer using another one in PWM mode (used to drive the green LED on the GPIO). The same signal that drives the green LED acts as the external CLK source for an internal reference timer. Timer 3 PWM is used to clock Timer 0. Follow the below easy steps to finish wiring.

* Step 1: Connect ```PORTD7 to PORTB6``` (same as the green GPIO LED). Schematic naming ```D6 -> D10```.
* Step 2: Make sure that the above connection is stable (not wiggling). Double check the connections. ```PORTD7 -> PORTB6 (D6 -> D10)```.

If the above wiring is not done, ALL the readings from my system WILL BE GARBAGE. So, please connect them correctly. But once done, you'll get highly accurate measurements!

NOTE: All experiments can be run error free for upto 65 seconds (when the green LED is configured to toggle every 100ms). If run longer than 65 seconds, the reported results are just unreliable.

Use a standard ```FTDI cable``` using ```RX1/TX1``` for getting the ```UART menu``` up.

## Standard Menu

This is how the standard menu looks like. You can modify it to fit your needs in ```uart_menu.c```.

```
------------------------------------------------------------
                EXPERIMENTATION MENU
------------------------------------------------------------
p        -> Print collected experiment data
e <num>  -> Setup experiment number <num>(1-8)
r <num>  -> Set the green LED task to <num>(1-4194) ms
z        -> Reset all experimentation data
g        -> Start the experiment just configured
q        -> Quit menu and go back to normal mode
------------------------------------------------------------
```

## Example: Experiment 2

* Experiment 2 places a 20ms busy-wait inside green LED counting ISR. This basically results in blocking other high frequency interrupts like the timekeeping task which miss deadlines. Task releases for Hough and red LED are also affected since their releases are delayed until the green LED ISR finishes. Further more, a 20ms delay does not affect 100ms periodic ISRs much. This is seen from green LED counting task not missing any deadlines. Similarly, yellow LED task misses very few deadlines because it is released from an ISR which operates at a higher frequency than it's release. 20ms is still less than 25ms which is the period of yellow LED ISR (interrupts are saved until processed, unless overwritten by the same interrupt).
```
----- Printing all experiment data -----
Experiment number: 2, Experimentation time (ms): 17400

1: Time keeper task:    times run:   13651  |  missed deadlines: 3749
2: Communication task:  times run:       1  |  missed deadlines: 0
3: Red LED task:        times run:     135  |  missed deadlines: 39
4: Yellow LED task:     times run:     172  |  missed deadlines: 2
5: Jitter LED task:     times run:     146  |  missed deadlines: 22
6: Green LED task:      times run:     174  |  missed deadlines: 0
7: Green count task:    times run:     174  |  missed deadlines: 0
8: Hough trans task:    times run:     135  |  missed deadlines: 39
```

